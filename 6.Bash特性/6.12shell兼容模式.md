## 6.12 shell兼容模式

Bash-4.0引入了一个shell兼容级别的概念，其作为shopt内建命令的一组选项指定（compat31、compat32、compat40、compat41等等）。只有一个当前兼容级别有效，即每个选项是互斥的。兼容模式的意图在于允许用户选择使用以前版本的行为，这样在将脚本迁移到与之不兼容的更新版本时可以使用其当前的特性和行为。其只是一个临时解决方案。

这节所涉及的标准行为不是用于特定版本的（例如，设置级别compat32意味着将正则匹配操作符的右侧操作数引起来就是将在单词中的特殊正则字符引起来，其作为bash-3.2及以上版本的默认行为）。

如果一个用户启用了，比如说compat32，其可以影响到当前兼容级别之前的所有其它兼容级别的行为，也包括当前兼容级别。这个想法是让每一个兼容级别可控制改变该Bash版本的行为，但这个行为可能已存在于更早的版本中。例如，对于“\[\[”命令使用基于本地语言的比较是在bash-4.1出现的，更早版本是基于ASCII的比较，所以在bash-4.1中开启compat32也会开启基于ASCII的比较。这种粒度可能不会满足所有的使用需求，所以作为用户应该小心的选择兼容级别。阅读特定特性文档可以获知其行为。

Bash-4.3引入了一个新的shell变量：BASH_COMPAT。分配给该变量的值（像4.2这样的十进制小数，或一个对应于compatNN选项中的整数，像42）确定了兼容级别。

在bash-4.4之后，Bash开始不赞成使用更老版本的兼容级别。最终，这些选项都移入到BASH_COMPAT变量中。

Bash-5.0是可使用单一shopt选项设置之前兼容版本的最后一版。用户在bash-5.0和之后版本应该使用BASH_COMPAT变量进行兼容设置。

下列列表描述的是对于每一个兼容级别的行为变化控制。标记“compat*NN*”是使用下列机制中的一个来设置兼容级别“*NN*”的快捷方式。在bash-5.0以前的版本，可以设置相应“compat*NN*"的shopt选项来设置兼容级别。在bash-4.3及以后版本，推荐使用BASH-COMPAT变量，并且该访求是在bash-5.1及以后版本必须使用的。

#### compat31 

- 将“\[\[”命令的正则匹配操作符“=~”的右侧操作数引起来不会产生任何特殊效果。

#### compat32

- 在中断像“a ; b ; c”这样的命令列表时，会继续执行列表中的下一条命令。（在bash-4.0及以后版本，shell的动作就像收到不断一样，所以中断列表中的一个命令就会中止整个列表的执行）

#### compat40

- “\[\[”命令中的操作符“<”和“>”在进行比较字符串时是不会考虑当前区域语言的；它们是使用ASCII顺序。在bash-4.1之前的版本使用ASCII校验和strcmp(3)；在bash-4.1及之后版本使用当前区域语言校验序列和strcoll(3)。

#### compat41 

- 在POSIX模式中，跟随在time后面的选项仍然是会被认为是一个保留字（这是POSIX说明267号）。
- 在POSIX模式中，解析器要求一个偶数单引号出现在双引号中的参数扩展“${...}”中的word部分并且对其进行特殊处理，以便在单引号内的字符是被认为是引起来的（这是POSIX说明221号）。

#### compat42

- 在双引号样式替换中的替换字符串不会进行引用移除，在bash-4.2之后的版本也是如此。
- 在POSIX模式中，当扩展在双引号引用的参数扩展“${...}”的word部分时，单引号会认为是特殊的，并且可用于将后半个大括号与或其它特殊字符引起来（这是POSIX说明221号）；在其后版本中，在双引号单词扩展中的单引号是没有特殊含义的。

#### compat43

- 如果试图使用引起来的复合赋值语句作为declare命令的一个参数（declare -a foo='(12)'），shell不会打印警告消息。其后版本会警告不赞成使用该方法。
- 会认为单词扩展错误是引起当前命令失败的非致命性错误，即使是在POSIX模式（默认的行为是认为是致命错误并会引起shell退出）。
- 当执行一个shell函数，循环状态（while、until等等）没有重置时，在函数中的break和continue将会在调用上下文中中断或继续循环。bash-4.4及以后版本会重置循环状态以防止这种情况发生。

#### compat44

- 即使没有开启扩展调试模式，shell会使用BASH_ARGV和BASH_ARGC来设置扩展为shell位置参数的值。
- 一个子shell会从其父shell的上下文中继承循环，因此break和continue将会引起子shell退出。bash-5.0及以后版本会重置循环状态以防止退出。
- 在像export和readonly内建命令设置属性之前的变量赋值，会继续影响在调用环境中相同名称的变量，即使shell不在POSIX模式。

### compat50（设置使用BASH_COMPAT）

- bash-5.1改变了$RANDOM的随机方法，使其产生的随机数更随机了一点。如果shell兼容级别设置为50或更低，其会恢复到bash-5.0及以前版本的方式。因此给RANDOM分配一个值来产生的随机数生成器将会产生像在bash-5.0里一样的序列。
- 如果命令哈希表是空的，早于bash-5.1版本的Bash会打印一个有效的通知消息即使当所产生的输出可重用作为输入。bash-5.1在使用了“-l”选项后，会抑制该消息。