## 3.6 重定向（Redirections）

在一个命令执行之前，shell可以使用一个特殊符号将其输入和输出解释为重定向。重定向允许对命令的文件控制句柄进行复制、打开和关闭，使其引用到不同的文件，并且使命令的读取和写入来改变文件。重定向也可以用于改变当前shell执行环境的文件控制句柄。下面的重定向操作符可能出现在一个简单命令里的任意位置或前面，或在命令后面。重定向依照从左到右的顺序进行处理。

每一个重定向前面可以带有一个文件描述符数字，也可使用`{varname}`形式的单词代替。在这种情况下， shell将为每一个重定向操作符（除了`>&-`和`<&-`）分配一个大于10的文件描述符给`{varname}`。如果在`>&-`或`<&-`前面是`{varname}`，则关闭varname值定义的文件描述符。如果提供了`{varname}`，则重定向的存在将超出命令执行的范围，这允许程序员手动管理文件描述符的生命周期。

在下面的描述中，如果省略了文件描述符数字，并且重定向操作符的第一个字符是“<”，则重定向引用到标准输入（即文件描述符0）。如果重定向操作符的第一个字符是“>”，则重定向引用到标准输出（即文件描述符1）。

在下面描述中跟随在重定向操作符后的单词，除非有其它注释，都受大括号扩展、波浪号扩展、参数扩展、命令替换、算术扩展、引用移除、文件名扩展和单词分割的管制。如果扩展出多于一个单词的结果，Bash则报错。

注意，重定向的顺序是很重要的。例如，命令

`ls > dirlist  2>&1`

是将标准输出（即文件描述符1）和标准报错（即文件描述符2）定向到文件`dirlist`中去，而命令

`ls 2>&1 > dirlist`

只将标准输出定向到文件`dirlist`中，因为在标准输出重定向到文件`dirlist`之前就将标准报错的一个副本复制到标准输出了。

在下表的描述中，Bash会特殊处理一些用于重定向的文件。如果运行Bash的操作系统提供了这些特殊文件，则bash会使用它们；否则Bash将在内部模拟它们下面所描述的行为。

文件 | 描述
--- | ---
/dev/fd/`fd` | 如果`fd`是一个有效整数，则复制文件描述符`fd`。
/dev/stdin | 复制文件描述符0。
/dev/stdout | 复制文件描述符1。
/dev/stderr | 复制文件描述符2。
/dev/tcp/host/port | 如果host是一个有效的主机名或Internet地址，并且port是一个整数或服务名，Bash则试图打开一个相应的TCP套接层。
/dev/udp/host/port | 如果host是一个有效的主机名或Internet地址，并且port是一个整数或服务名，Bash则试图打开一个相应的UDP套接层。

打开或创建文件失败，会引起重定向的失败。

在重定向中使用文件描述符大于9时要特别小心，因为其可能会与shell内部使用的文件描述符相冲突。

### 3.6.1 输入重定向

输入重定向引发文件描述符n打开从单词扩展所生成的文件名的文件进行读操作。或如果没有指定n时，则从标准输入（即文件描述符为0)进行读操作。

重定向输入的一般格式是：

`[n]<word`

### 3.6.2 输出重定向

输出重定向引发文件描述符n打开从单词扩展所生成的文件名的文件进行写操作。或如果没有指定n时，则从标准输出（即文件描述符为1)进行写操作。如果文件不存在，则创建该文件；如果文件存在，则将其大小删减为零。

输出重定向的一般格式是：

`[n]>[|]word`

如果重定向操作符是“>”，并且内建命令set的选项“noclobber”开启了，再如果从word扩展生成的文件名的文件是存在的并且是一个常规文件，则重定向会失败。如果重定向操作符是“>|”，或操作符是“>”并且“noclobber”没有开启，则会试图进行重定向，即使word所产生的文件名存在。

### 3.6.3 输出重定向追加

这种方式的输出重定向引发文件描述符n打开从单词扩展所生成的文件名的文件进行追加操作。或如果没有指定n时，则从标准输出（即文件描述符为1)进行追加操作。如果文件不存在，则创建该文件。

追加输出的一般格式是：

`[n]>>word`

### 3.6.4 标准输出和标准报错重定向

这种结构允许标准输出（即文件描述符1）和标准报错（即文件描述符2）都被重定向到由word扩展得到的文件名的文件。

标准输出和标准报错重定向有两种格式：

`&>word`

和

`>&word`

在两种格式中第一种是推荐的。这在语义上等同于`>word 2>&1`。

在使用第二种格式时，word不能扩展成一个数字或“-”。如果这么做了，出于兼容性原因会应用为另外一种重定向操作符（参见下面的《复制文件描述符》）。

### 3.6.5 标准输出和标准报错追加

这种结构允许标准输出（即文件描述符1）和标准报错（即文件描述符2）都被重定向追加到由word扩展得到的文件名的文件。

标准输出和标准报错追加格式是：

`&>>word`

这在语义上等同于`>>word 2>&1`（参见下面的《复制文件描述符》）。

### 3.6.6 Here Documents（不知道如何翻译）

这种类型的重定向指示shell从当前输入源进行读取，直到读取到再次出现单行的word（不带尾部空白的）时结束。读取的所有行之后被用作命令的标准输入（或如果指定的是n，则是文件描述符n）。

here-documents的格式是：

```
[n]>>[-]word
    here-document
delimiter
```

word不会由执行参数和变量扩展、命令替换、算术扩展或文件名扩展生成。如果word的任意部分被引起来了，则delimiter是word引用移除后的结果，并且here-document里的所有行不会进行扩展。如果word是未被引起来的，则here-document的所有行可以由参数扩展、命令替换和算术扩展生成，字符序列`\newline`会被忽略，并且字符“\”、“$”和“`”必须使用“\”进行转义。

如果重定向操作符是“<<-”时，所有输入行的起始位置的tab字符都将被去除，这也包括delimiter行的。这允许在shell脚本中的here-document使用缩进样式。

### 3.6.7 Here-Strings（不知道怎么翻译）

这是here-document的一个变体，格式是：

`[n]<<< word`

word可以由波浪号扩展、参数和变量扩展、命令替换、算术扩展和引用移除生成。文件名扩展和单词分割不会在这里执行。这提供了一个带有换行的单行字符串作为命令的标准输入（或文件描述符n，如果n指定了的话）。

### 3.6.8 文件描述符复制

重定向操作符`[n]<&word`用于复制输入文件描述符。如果word扩展为一位或多位数字，则由n表示的文件描述符作为该文件描述符的副本。如果在word中的数字没有指定一个用于输入的文件描述符，则会出现重定向报错。如果word评估为“-”，文件描述符n将被关闭。如果未指定n，则使用标准输入（即文件描述符0）。

操作符`[n]>&word`同样用于复制输出文件描述符。如果没有指定n，则使用标准输出（即文件描述符1）。如果word的数字未指定一个输出文件描述符打开，则出现重定向报错。如果word是“-”，则关闭文件描述符n。在特殊情况下，如果省略了n，并且word没有扩展为一位或多位数字或“-”，则标准输出和标准报错重定向为前面描述的样子。

### 3.6.9 文件描述符移动

重定向操作符`[n]<&digit-`移动文件描述符digit到文件描述符n，或如果未指定n，则移动到标准输入（即文件描述符0）。在digit复制到n后将其关闭。

同样地，重定向操作符`[n]>&digit-`移动文件描述符digit到文件描述符n，或如果未指定n，则移动到标准输出（即文件描述符1）。

### 3.6.10 用于读取和写入的文件描述符打开

重定向操作符`[n]<>word`会引起由word扩展得到的文件名打开，用于对文件描述n的读取和写入。或如果没有指定n，则文件描述符为0。如果文件不存在，则创建它。